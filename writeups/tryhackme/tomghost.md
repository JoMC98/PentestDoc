# Tomghost

`Try Hack Me` `Linux` `CVE-2020-1938` `Tomcat` `Ghostcat` `PGP` `john` `sudo` `ZIP`

## Flags

* **User Flag:** `THM{GhostCat_1s_so_cr4sy}`
* **Root Flag:** `THM{Z1P_1S_FAKE}`

## Users

* skyfuck _\(pwd: `8730281lkjlkjdqlksalks`\)_
* merlin _\(pwd: `asuyusdoiuqoilkda312j31k2j123j1g23g12k3g12kj3gk12jg3k12j3kj123j`\)_

## **Enumeración**

Vemos si el host esta levantado y identificamos el SSOO con `ping -c1 IP`

> Linux: TTL &lt;= 64
>
> Windows: TTL &gt;= 65 & &lt;= 128

![](https://i.imgur.com/1cX27hX.png)

### Escaneo de puertos

Primero vemos si va muy lento el escaneo: `nmap -p- --open -T5 -v -n IP`

```text
-p-         Todos los puertos 
--open      Mostrar solos puertos abiertos 
-T5         Modo más agresivo 
-v          Modo verbose (reporta por pantalla) 
-n          No aplicar resolución DNS
```

Como va lento, lanzamos este otro comando: `nmap -sS --min-rate 5000 -p- -vvv -n -Pn IP`

```text
-sS           Realizar un TCP SYN port scan
--min-rate    Emitir al menos 5000 paquetes por segundo
-Pn           No realizar Host Discovery
```

Va más rápido y encuentra los puertos 22 \(SSH\), 53 \(DNS\), 8080 \(HTTP\) y 8009 \(ajp13\)

![](https://i.imgur.com/IqnvcRN.png)

Obtenemos los servicios que corren en los puertos `nmap -sC -sV -p22,53,8009,8080 IP`

![](https://i.imgur.com/yAhlAsv.png)

> Vemos que el AJP13 es un servicio de Apache Jserv, que es una especie de API para servidores web Apache.
>
> Vemos también que el puerto 53, para resolución de DNS, nos muestra **tcpwrapped**, lo que indica que está abierto pero nos está bloqueando algún firewall o IPS.

### Servicio HTTP

Lanzamos un whatweb para ver si tiene algún CMS tipo Wordpress: `whatweb IP:8080`

![](https://i.imgur.com/5RWAKfm.png)

Vemos que es un Apache Tomcat normal. Accedemos al portal web y vemos la página por defecto de Tomcat. Vemos el código fuente de la página a ver si encontramos algo. No hay nada

Vamos a hacer un **fuzzing** en el portal para encontrar alguna ruta con **GoBuster**`gobuster dir -u IP:8080 -w DICT -q -n -e`

```text
-u        Target 
-w         Diccionario (/usr/share/wordlists/dirb/common.txt)
-q        Silencioso, no muestra mensajes de estado           
-n        No muestra códigos de estado        
-e        Muestra URLs completas
```

![](https://i.imgur.com/Zj3VkN4.png)

Navegamos por la web pero no encontramos nada. En los paths encontrados tampoco, no tenemos autorización para entrar al **manager**.

### Tomcat - Ghostcat

Buscamos posibles exploits para Tomcat. Hay muchos, pero pocos para la versión **`9.0.30`**. Nos llama la atención este, por el nombre de la propia máquina:

![](https://i.imgur.com/KL5TCR9.png)

Buscamos info sobre _**Ghostcat**_ y vemos que es una vulnerabilidad conocida que afecta a todas las versiones de tomcat.

> La vulnerabilidad se encuentra en el protocolo de AJP, que hemos visto en el puerto 8009, que se usa para comunicar a Tomcat con Apache.

{% embed url="https://unaaldia.hispasec.com/2020/02/ghostcat-vulnerabilidad-que-afecta-a-todas-las-versiones-de-tomcat-activa-desde-hace-13-anos.html" caption="" %}

Tiene CVE asociado \(**`CVE-2020-1938`**\) y exploits:

{% embed url="https://www.exploit-db.com/exploits/48143" caption="" %}

Nos copiamos el exploit y lo ejecutamos, sin indicar ficheros:

![](https://i.imgur.com/9Ihbjv1.png)

## **Getting a shell**

Nos llama la atención este mensaje:

![](https://i.imgur.com/PXVgOlN.png)

Parece un usuario **`skyfuck`** y su password. Probamos a conectar por SSH.

![](https://i.imgur.com/fNPj2J9.png)

{% hint style="warning" %}
Tenemos un usuario **`skyfuck`** y su password **`8730281lkjlkjdqlksalks`**
{% endhint %}

{% hint style="danger" %}
Podemos tener acceso sin contraseña copiando nuestra Clave Pública SSH

```bash
#ON MACHINE
cd
mkdir -p ~/.ssh
echo "[MY LOCAL ~/.ssh/id_rsa.pub]" >> ~/.ssh/authorized_keys

#ON KALI
ssh -i ~/.ssh/id_rsa USER@IP
```
{% endhint %}

### **PGP**

En el directorio de skyfuck no encontramos la flag, pero vemos dos ficheros:

![](https://i.imgur.com/aLuiqzh.png)

Uno parece una Clave PGP y el otro un contenido cifrado con PGP. Nos lo descargamos a nuestra máquina.

Leemos un poco de info sobre PGP y lo que vemos es que el **.asc** es una clave privada PGP y el **.pgp** es un fichero cifrado con una clave PGP.

La clave vemos que tiene contraseña, por lo que intentamos crackearlo con **john**:

Primero, convertimos la Clave PGP en un hash para john, con gpg2john

```text
#Convertir el zip a un hash
/usr/sbin/gpg2john PGP_KEY > hash.txt

#Crack the password con Rockyou
/usr/sbin/john --wordlist=DICT hash.txt
```

![](https://i.imgur.com/jyy36Ym.png)

{% hint style="info" %}
Tenemos la password de la clave PGP **`alexander`**
{% endhint %}

Con **`gpg`** podemos descifrar el fichero cifrado con PGP usando la clave privada e introduciendo la password encontrada.

```text
#Cargamos la clave PGP
gpg --import tryhackme.asc

#Desciframos el fichero
gpg --decrypt credentials.pgp
```

![](https://i.imgur.com/dKcUklR.png)

{% hint style="warning" %}
Tenemos un nuevo usuario **`merlin`** y su password **`asuyusdoiuqoilkda312j31k2j123j1g23g12k3g12kj3gk12jg3k12j3kj123j`**
{% endhint %}

![](https://i.imgur.com/vz4L3Zl.png)

{% hint style="danger" %}
De nuevo, podemos tener acceso sin contraseña copiando nuestra clave SSH.
{% endhint %}

### **User flag**

En el directorio de **merlin** si que encontramos la user flag.

{% hint style="success" %}
USER FLAG: **`THM{GhostCat_1s_so_cr4sy}`**
{% endhint %}

## **Privilege Escalation**

Vamos a intentar una escalada de privilegios en Linux siguiendo este [tutorial](https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4):

{% embed url="https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4" caption="" %}

También podemos lanzar este [script ](https://github.com/rebootuser/LinEnum)para enumerar el sistema:

{% file src="../../.gitbook/assets/linenum.sh" caption="Linux Enumeration Script" %}

### Sudo and SUID files

En primer lugar, intentamos ver los privilegios de sudo del usuario merlin. Probamos a ejecutar el comando `sudo -l`.

![](https://i.imgur.com/sF96Fa2.png)

Vemos que puede ejecutar el comando zip sin contraseña. Miramos en esta gúia:

{% embed url="https://gtfobins.github.io/" caption="" %}

El comando zip tiene posibilidad de escalar a privilegios con sudo:

![](https://i.imgur.com/X40W4jS.png)

Lo probamos:

```text
TF=$(mktemp -u)
sudo zip $TF /etc/hosts -T -TT 'sh #'
```

![](https://i.imgur.com/gvcphB5.png)

### **Root Flag**

Hemos escalado privilegios. Vamos al directorio **`/root`** a por la **root.txt** flag.

{% hint style="success" %}
ROOT FLAG: **`THM{Z1P_1S_FAKE}`**
{% endhint %}

