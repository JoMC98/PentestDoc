# Blog

`Try Hack Me` `Linux` `CMS Wordpress` `SMB` `wpscan` `xmlrpc` `CVE-2019-8942` `CVE-2019-8943` `Metasploit` `SUID` `ltrace`

## Flags

* **User Flag:** `c8421899aae571f7af486492b71a8ab7`
* **Root Flag:** `9a0b2b618bef9bfa7ac28c1353d9f318`

## Users

* bjoel en WP
* kwheel en WP _\(pwd: `cutiepie1`\)_

## **Enumeración**

Antes de empezar, en THM vemos que hay que añadir el dominio **`blog.thm`** al fichero **`/etc/hosts`**:

![](https://i.imgur.com/tMO20WX.png)

Vemos si el host esta levantado y identificamos el SSOO con `ping -c1 IP`

> Linux: TTL &lt;= 64
>
> Windows: TTL &gt;= 65 & &lt;= 128

![](https://i.imgur.com/H0aqQzQ.png)

### Escaneo de puertos

Primero vemos si va muy lento el escaneo: `nmap -p- --open -T5 -v -n IP`

```text
-p-         Todos los puertos 
--open      Mostrar solos puertos abiertos 
-T5         Modo más agresivo 
-v          Modo verbose (reporta por pantalla) 
-n          No aplicar resolución DNS
```

Como va lento, lanzamos este otro comando: `nmap -sS --min-rate 5000 -p- -vvv -n -Pn IP`

```text
-sS           Realizar un TCP SYN port scan
--min-rate    Emitir al menos 5000 paquetes por segundo
-Pn           No realizar Host Discovery
```

Va más rápido y encuentra los puertos 22 \(SSH\), 80 \(HTTP\), 139 y 445 \(SMB\)

![](https://i.imgur.com/LK9Glk0.png)

Obtenemos los servicios que corren en los puertos `nmap -sC -sV -p22,80,139,445 IP`

![](https://i.imgur.com/bZSXbq6.png)

Confirmamos que tenemos un SSH, un SMB y un HTTP con Wordpress.

### Servicio SMB

Listamos las unidades compartidas de forma anónima:

```text
smbclient -L \\\\IP -N
```

![](https://i.imgur.com/GITsKoG.png)

Vemos un Disco compartido **`BillySMB`**. Probamos a conectarnos:

```text
smbclient //IP/BillySMB -N
```

![](https://i.imgur.com/qBTv1Mo.png)

Se conecta y vemos una serie de ficheros. Parecen troll, pero probamos a descargarlos a la máquina con `get FILE`.

![](https://i.imgur.com/ekIWYh4.png)

Es bastante troll, tenemos un video de Taylor Swift, una imagen de un conejo y un QR que nos lleva a esta maravilla:

{% embed url="https://www.youtube.com/watch?v=eFTLKWw542g&ab\_channel=billyjoelVEVO" caption="" %}

Podríamos hacerle stego a los ficheros pero pasando de momento.

### Servicio HTTP

Sabemos ya que es un Wordpress por lo que hemos visto en nmap, pero lanzamos un whatweb para ver que nos da: `whatweb IP`

![](https://i.imgur.com/ULzopk2.png) `5.0` V.emos lo mismo y nos dice la versión de WP **`5.0`**. Accedemos al portal web y vemos el blog. Con Wappalyzer vemos lo mismo:

![](https://i.imgur.com/kfZmXQl.png)

{% hint style="info" %}
Hay un comentario de **`Karen Wheeler`**, por lo que tenemos un potencial usuario.
{% endhint %}

![](https://i.imgur.com/njhOven.png)

{% hint style="info" %}
Tenemos otro potencial usuario **`Billy Joel`**
{% endhint %}

Vamos a hacer un **fuzzing** en el portal para encontrar alguna ruta con **GoBuster**`gobuster dir -u IP -w DICT -q -n -e`

```text
-u        Target 
-w         Diccionario (/usr/share/wordlists/dirb/common.txt)
-q        Silencioso, no muestra mensajes de estado           
-n        No muestra códigos de estado        
-e        Muestra URLs completas
```

![](https://i.imgur.com/ufnBxol.png)

Vemos paths interesantes pero la mayoría reenvían al login de WP o a posts, por lo que no tiene mucho sentido rascar por ahí. Vamos directo al wordpress.

## Wordpress

Lanzamos un comando de enumeración de wordpress: **`wpscan --url IP`**

Podemos ver la versión de Worpress de nuevo y nos dice que es inseguro:

![](https://i.imgur.com/8e0R7qz.png)

También vemos que el tema es **twentytwenty**, también bastante antiguo.

### xmlrpc

Podemos consultar también la API **`IP/wp-json/wp/v2/users`** para ver si hay usuarios. Obtenemos los 2 que habiamos visto antes: **Billy** y **Karen**

{% hint style="info" %}
Tenemos 2 usuarios de WP: **`bjoel`** y **`kwheel`**
{% endhint %}

![](https://i.imgur.com/uNyZkJS.png)

Con wpscan vemos que está habilitado el **xml-rpc**.

![](https://i.imgur.com/YuSVAfV.png)

Lo podemos explotar para hacer fuerza bruta, siguiendo esta guía

{% embed url="https://nitesculucian.github.io/2019/07/01/exploiting-the-xmlrpc-php-on-all-wordpress-versions/" caption="" %}

Intentamos hacer fuerza bruta sobre los 2 usuarios encontrados con **`rockyou.txt`**

Vemos que wpscan tiene una opción para hacer fuerza bruta sobre el xmlrpc con la opción Multicall:

```text
wpscan --url IP -U kwheel -P ROCKYOU
```

![](https://i.imgur.com/pkRfB2O.png)

{% hint style="success" %}
Tenemos la password de **kwheel**: **`cutiepie1`**
{% endhint %}

Conseguimos el acceso a WP, pero el usuario no es admin, por lo que no podemos explotar el uso de plantillas.

![](https://i.imgur.com/9aRncZL.png)

### RCE

Buscamos exploits sobre la versión de WP.

![](https://i.imgur.com/a2EAyy6.png)

Los exploits son sobre los **`CVE-2019-8942`** y **`CVE-2019-8943`**, vulnerabilidad encontradas para está versión de WP.

{% embed url="https://www.exploit-db.com/exploits/49512" caption="" %}

Probamos a copiarnos el exploit y lo leemos.

Vemos que necesitamos indicar usuario, password y tema del WP.

![](https://i.imgur.com/v7HdgGE.png)

Cambiamos también nuestra IP y puerto donde estamos escuchando con `nc -lvp 5555`

![](https://i.imgur.com/pf9meHM.png)

Lo ejecutamos con:

```text
python3 exploit.py http://blog.thm/ kwheel cutiepie1 twentytwenty
```

![](https://i.imgur.com/0XQ9Fr2.png)

Nos dice que funciona pero no conseguimos una shell.

## Metasploit - Getting a shell

Probamos con otro exploit en Metasploit.

{% embed url="https://www.exploit-db.com/exploits/46662" caption="" %}

Buscamos el exploit con **`search crop-image`**, lo elegimos con **`use`** y vemos los parámetros con **`options`**

![](https://i.imgur.com/bVrRtnn.png)

Configuramos todas las opciones \(USERNAME, PASSWORD, RHOSTS y LHOST\) con **`set`**

![](https://i.imgur.com/qFvXoT8.png)

Lo ejecutamos con **`run`**:

![](https://i.imgur.com/VSZLIGX.png)

Conseguimos una shell en Meterpreter

{% hint style="danger" %}
Podemos transformar la shell de Meterpreter en una de bash con:

```text
sessions -i 1
shell
script -qc /bin/bash /dev/null
```
{% endhint %}

![](https://i.imgur.com/nJXte2x.png)

En el directorio de bjoel vemos un **user.txt** flag pero es troll.

![](https://i.imgur.com/WBV0xtN.png)

## **Privilege Escalation**

Hemos visto también un PDF. Lo descargamos desde Metasploit con **`download`**

![](https://i.imgur.com/EmVAhrM.png)

Dentro del PDF, vemos que nombra una empresa "**Rubber Ducky Inc**".

![](https://i.imgur.com/5tIHE0U.png)

Buscamos info sobre [Rubber Ducky](https://shop.hak5.org/products/usb-rubber-ducky-deluxe) y vemos que es un tipo de USB.

Buscamos en **`/media`** y vemos que hay un directorio **`usb`** montado, pero no podemos acceder.

![](https://i.imgur.com/EL46k1R.png)

### SUID files

Buscamos los ficheros con el SUID activo.

`find / -user root -perm -4000 2>/dev/null`

![](https://i.imgur.com/s3YaanG.png)

Podemos buscar alguno que nos llame la atención de esta guía:

{% embed url="https://gtfobins.github.io/" caption="" %}

No hay ninguno en la lista pero nos llama la atención **`/usr/sbin/checker`**. Al ejecutarlo nos dice "Not an admin".

![](https://i.imgur.com/KXSllvb.png)

Usamos **`ltrace`** para ver los métodos y funciones que se ejecutan.

![](https://i.imgur.com/n4fJJrb.png)

Vemos algo muy interesante. Se utiliza la función **`getenv("admin")`** que obtiene el valor de la variable de entorno **admin**.

![](https://i.imgur.com/v7almdP.png)

Parece que esta vacío o null. Probamos a poner la variable a 1 con **`export admin=1`** y lo volvemos a ejecutar.

![](https://i.imgur.com/XiOPZuk.png)

### **User and Root Flag**

Hemos escalado privilegios. Vamos al directorio **`/root`** a por la **root.txt** flag.

![](https://i.imgur.com/kPl4G9F.png)

{% hint style="success" %}
ROOT FLAG: **`9a0b2b618bef9bfa7ac28c1353d9f318`**
{% endhint %}

Vamos también de nuevo a **`/media/usb`** a ver si vemos ahí la flag de user.

{% hint style="success" %}
USER FLAG: **`c8421899aae571f7af486492b71a8ab7`**
{% endhint %}

