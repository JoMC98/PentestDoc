# Madness

`Try Hack Me` `Linux` `Stego` `BruteForce` `screen` `SUID` `ExploitDB`

## Flags

* **User Flag:** `THM{d5781e53b130efe2f94f9b0354a5e4ea}`
* **Root Flag:** `THM{5ecd98aa66a6abb670184d7547c8124a}`

## Users

* joker _\(pwd: `axA&GF8dP`\)_

## **Enumeración**

Vemos si el host esta levantado y saber el SSOO \(**Linux**: TTL &lt;= 64\) `ping -c1 IP`

### Escaneo de puertos

Primero vemos si va muy lento el escaneo: `nmap -p- --open -T5 -v -n IP`

```text
-p-         Todos los puertos 
--open      Mostrar solos puertos abiertos 
-T5         Modo más agresivo 
-v          Modo verbose (reporta por pantalla) 
-n          No aplicar resolución DNS
```

Como va lento, lanzamos este otro comando: `nmap -sS --min-rate 5000 -p- -vvv -n -Pn IP`

```text
-sS           Realizar un TCP SYN port scan
--min-rate    Emitir al menos 5000 paquetes por segundo
-Pn           No realizar Host Discovery
```

Va más rápido y encuentra los puertos 22 \(SSH\) y 80 \(HTTP\)

![](https://i.imgur.com/Kaxg51I.png)

Obtenemos los servicios que corren en los puertos `nmap -sC -sV -p22,80 IP`

![](https://i.imgur.com/AXmB3U2.png)

### Servicio HTTP

Lanzamos un whatweb para ver si tiene algún CMS tipo Wordpress: `whatweb IP`

![](https://i.imgur.com/2Rjqchi.png)

Vemos que es un Apache normal. Accedemos al portal web y vemos la página por defecto de apache. Vemos el código fuente de la página a ver si encontramos algo. No hay nada

Vamos a hacer un **fuzzing** en el portal para encontrar alguna ruta con **GoBuster**`gobuster dir -u IP -w DICT -q -n -e`

```text
-u        Target 
-w         Diccionario (/usr/share/wordlists/dirb/common.txt)
-q        Silencioso, no muestra mensajes de estado           
-n        No muestra códigos de estado        
-e        Muestra URLs completas
```

![](https://i.imgur.com/dt0qCBd.png)

No encontramos nada en el fuzzing. Volvemos al portal y vemos algo raro:

![](https://i.imgur.com/ebjNqxh.png)

En el código fuente vemos una sorpresita que no habíamos visto antes:

![](https://i.imgur.com/89kKjbn.png)

## **Stego**

Descargamos la imagen \(que no es una imagen\) y le pasamos varios comandos de Stego

Con `file thm.jpg` vemos que es de tipo data

Con `strings thm.jpg` no vemos ningún string útil

Con `exiftool thm.jpg` no vemos ningun metadata útil

Con `binwalk -e thm.jpg` no encuentra ficheros ocultos

Con `steghide --info thm.jpg` el tipo de fichero no es reconocido

Con `stegcracker thm.jpg ROCKYOU` no encuentra nada y lo paramos

Con `ghex thm.jpg` vemos que tiene la File Signature de un PNG, pero es un JPG

### File signature

Probamos a cambiar la signature por la de JPG `FF D8 FF E0 00 10 4A 46` y guardamos el fichero. Usamos esta [guía de wikipedia](https://en.wikipedia.org/wiki/List_of_file_signatures).

{% hint style="info" %}
Conseguimos abrir la imagen y vemos un path oculto**`IP/th1s_1s_h1dd3n/`**
{% endhint %}

![](https://i.imgur.com/WNP2qkD.png)

### Brute Forcing

En el código fuente vemos que dice que el `secret` va de 0-99, pero no sabemos como se introduce.

![](https://i.imgur.com/vWkWn30.png)

Probamos con `?secret=1` y funciona:

![](https://i.imgur.com/YH23tm4.png)

Montamos un script para que lanze fuerza bruta

```bash
for i in {0..99}; do
        echo -n "$i"
        wget http://IP/th1s_1s_h1dd3n/?secret=$i -O - 2> /dev/null | grep -oP "<p>.*</p>" | grep -i -ve "obtain my identity" -ve "Secret Entered"
done
```

Vemos que el secret es **73** y nos devuelve un mensaje. Parece un usuario codificado o una password.

![](https://i.imgur.com/zUcYiwz.png)

{% hint style="info" %}
Encontramos un código**`y2RPJ4QaPF!B`**
{% endhint %}

### Steghide

Probamos de nuevo el `steghide thm.jpg` sobre la imagen JPG correcta \(no la que tenía cabecera de PNG\) e introducimos el código/password encontrado

![](https://i.imgur.com/LKKTFEs.png)

Vemos un fichero **`hidden.txt`**. 

{% hint style="warning" %}
Tenemos un posible usuario: **`wbxre`**
{% endhint %}

### CyberChef

No sabemos donde usar ese usuario, por SSH con el código/password no funciona. Y no hay que hacer brute-force de SSH. Miramos un Write-Up y vemos que el usuario estaba cifrado. En [CyberChef ](https://gchq.github.io/CyberChef/#recipe=ROT13%28true,true,false,13%29&input=d2J4cmU)vemos que es ROT13 \(**César**\).

![](https://i.imgur.com/fkBe9Mv.png)



{% hint style="warning" %}
Tenemos un usuario: **`joker`**
{% endhint %}

### More stego

De nuevo lo mismo, no sabemos donde usar el usuario. Tras mucho rato probando cosas, vemos el Write-Up y dice que debemos hacer stego sobre la imagen del propio portal de THM:

![](https://i.imgur.com/aB9DwjK.png)

Descargamos la imagen y probamos a pasarle `steghide`. Primero introducimos la password anterior pero no funciona. Probamos sin password y funciona:

![](https://i.imgur.com/Qkpkwh5.png)

{% hint style="warning" %}
Tenemos la password de _joker_: **`*axA&GF8dP`**
{% endhint %}

## **Getting a shell**

Tenemos ya un usuario/password, por lo que conectamos por SSH:

![](https://i.imgur.com/FBLgRmC.png)

{% hint style="danger" %}
Podemos tener acceso sin contraseña copiando nuestra Clave Pública SSH

```bash
#ON MACHINE
cd
mkdir -p ~/.ssh
echo "[MY LOCAL ~/.ssh/id_rsa.pub]" >> ~/.ssh/authorized_keys

#ON KALI
ssh -i ~/.ssh/id_rsa USER@IP
```
{% endhint %}

### **User Flag**

En el directorio de joker vemos la **user.txt** flag.

{% hint style="success" %}
USER FLAG: **`THM{d5781e53b130efe2f94f9b0354a5e4ea}`**
{% endhint %}

## Privilege Escalation

Vamos a intentar una escalada de privilegios en Linux siguiendo este [tutorial](https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4):

{% embed url="https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4" %}

 También podemos lanzar este [script ](https://github.com/rebootuser/LinEnum)para enumerar el sistema:

{% file src="../../.gitbook/assets/linenum.sh" caption="Linux Enumeration Script" %}

### Sudo and SUID files

En primer lugar, intentamos ver los privilegios de sudo del usuario joker. No puede ejecutar el comando `sudo -l`.

Buscamos los ficheros con el SUID activo. 

`find / -user root -perm -4000 2>/dev/null`

![](https://i.imgur.com/IGroLEv.png)

Podemos buscar alguno que nos llame la atención de esta guía

{% embed url="https://gtfobins.github.io/" %}

Nos llama la atención **`/bin/screen-4.5.0`**, aunque no hay explotación directa por SUID. Buscamos posibles exploits para esa versión de screen. Encontramos este exploit:

{% embed url="https://www.exploit-db.com/exploits/41154" %}

Lo descargamos y copiamos en la máquina. Al ejecutarlo nos encontramos con problemas. Probamos directamente a copiar todo el contenido en la terminal de la máquina:

![](https://i.imgur.com/wXpDWs7.png)

### **Root Flag**

Hemos escalado privilegios. Vamos al directorio **`/root`** a por la **root.txt** flag.

{% hint style="success" %}
ROOT FLAG: **`THM{5ecd98aa66a6abb670184d7547c8124a}`**
{% endhint %}

