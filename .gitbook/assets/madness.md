# Madness

###### tags: `Try Hack Me` `Linux` `Stego` `BruteForce` `screen` `SUID` `ExploitDB`
________________________

### **FLAGS:** 
    - User Flag: THM{d5781e53b130efe2f94f9b0354a5e4ea}
    - Root Flag: THM{5ecd98aa66a6abb670184d7547c8124a}

________________________

### **USERS:**
    - joker (pwd: axA&GF8dP)

________________________

### **ENUMERACIÓN**

1. Vemos si el host esta levantado y saber el SSOO (**Linux**: TTL <= 64)
<code>ping -c1 IP</code>

2. Escaneamos los puertos abiertos

    - Primero vemos si va muy lento el escaneo:
    <code>nmap -p- --open -T5 -v -n IP</code>
    
            -p-		Todos los puertos
            --open 	Mostrar solos puertos abiertos
            -T5		Modo más agresivo
            -v 		Modo verbose (reporta por pantalla)
            -n		No aplicar resolución DNS
        
    - Como va lento, lanzamos este otro comando:
    <code>nmap -sS --min-rate 5000 -p- -vvv -n -Pn IP</code>
    
            -sS		Realizar un TCP SYN port scan
            --min-rate	Emitir al menos 5000 paquetes por segundo
            -Pn		No realizar Host Discovery

     - Va más rápido y encuentra los puertos 22 (SSH) y 80 (HTTP)

        ![](https://i.imgur.com/Kaxg51I.png)

3. Obtenemos los servicios que corren en los puertos
<code>nmap -sC -sV -p22,80 IP</code>

    ![](https://i.imgur.com/AXmB3U2.png)

4. Nos centramos en el servidor web Apache. Lanzamos un whatweb para ver si usa algún CMS tipo Wordpress, pero vemos que no, es un Apache normal

    ![](https://i.imgur.com/2Rjqchi.png)

5. Accedemos al portal web y vemos la página por defecto de apache. Vemos el código fuente de la página a ver si encontramos algo. No hay nada

6. Vamos a hacer un fuzzing en el portal para encontrar alguna ruta con GoBuster

    <code>gobuster dir -u IP -w DICT -q -n -e</code>

            -u    	Target 
            -w     	Diccionario (/usr/share/wordlists/dirb/common.txt)
            -q		Silencioso, no muestra mensajes de estado           
            -n		No muestra códigos de estado        
            -e		Muestra URLs completas
        
    ![](https://i.imgur.com/dt0qCBd.png)

7. No encontramos nada en el fuzzing. Volvemos al portal y vemos algo raro:

    ![](https://i.imgur.com/ebjNqxh.png)    

    - En el código fuente vemos una sorpresita que no habiamos visto antes:

        ![](https://i.imgur.com/89kKjbn.png)

_________________

### **STEGO**

Descargamos la imagen (que no es una imagen) y le pasamos varios comandos de Stego:

- <code>file thm.jpg</code> --> Tipo data
- <code>strings thm.jpg</code> --> No vemos nada
- <code>exiftool thm.jpg</code> --> Nada
- <code>binwalk -e thm.jpg</code> --> Nada
- <code>steghide --info thm.jpg</code> --> Fichero no reconocido
- <code>stegcracker thm.jpg ROCKYOU</code> --> Nada
- <code>ghex thm.jpg</code> --> Vemos que tiene la File Signature de un PNG, pero es un JPG. Probamos a cambiar la signature por la de JPG "FF D8 FF E0 00 10 4A 46" y guardamos el fichero. Usamos esta [guía de wikipedia](https://en.wikipedia.org/wiki/List_of_file_signatures).

1. Conseguimos abrir la imagen y vemos un path oculto: "**IP/th1s_1s_h1dd3n/**". Vemos esto:

    ![](https://i.imgur.com/WNP2qkD.png)

    - En el código fuente vemos que dice que el secret va de 0-99, pero no sabemos como se introduce.

        ![](https://i.imgur.com/vWkWn30.png)

    - Probamos con ?secret=1 y funciona:

        ![](https://i.imgur.com/YH23tm4.png)

2. Montamos un script para que lanze fuerza bruta:
    
    ![](https://i.imgur.com/wezkVFs.png)

    - Lo ejecutamos y vemos que el secret es 73 y nos devuelve un mensaje. Parece un usuario codificado o una password.
    
    ![](https://i.imgur.com/zUcYiwz.png)
    
    <mark>Código: **y2RPJ4QaPF!B**</mark>

3. Probamos de nuevo el <code>steghide thm.jpg</code> sobre la imagen JPG correcta (no la que tenía cabecera de PNG).

    - Introducimos el código/password encontrado

        ![](https://i.imgur.com/LKKTFEs.png)

    - Vemos un fichero **hidden.txt**. Lo extraemos y dentro vemos un usuario: **wbxre**, aunque dice que no lo pondrá fácil.

4. No sabemos donde usar ese usuario, por SSH con el código/password no funciiona. Y no hay que hacer brute-force de SSH. Miramos un Write-Up y vemos que el usuario estaba cifrado. 

    - En [CyberChef](https://gchq.github.io/CyberChef/#recipe=ROT13(true,true,false,13)&input=d2J4cmU) vemos que es ROT13 (César).

        ![](https://i.imgur.com/fkBe9Mv.png)
        
        <mark>Tenemos un usuario: **joker**</mark>

5. De nuevo lo mismo, no sabemos donde usar el usuario. Tras mucho rato probando cosas, vemos el Write-Up y dice que debemos hacer stego sobre la imagen del propio portal de THM:

    ![](https://i.imgur.com/aB9DwjK.png)

    - Descargamos la imagen y probamos a pasarle <code>steghide</code>. Primero introducimos la password anterior pero no funciona. Probamos sin password y funciona:

    ![](https://i.imgur.com/Qkpkwh5.png)

    <mark>Tenemos la password de joker: ***axA&GF8dP**</mark>

- Conseguimos tener siempre acceso sin contraseña copiando nuestra Clave Pública SSH.
    
    - ON MACHINE:

        <code>cd; mkdir -p ~/.ssh; echo "[MY LOCAL ~/.ssh/id_rsa.pub]" >> ~/.ssh/authorized_keys</code>

    - ON KALI:
    
        <code>ssh -i ~/.ssh/id_rsa USER@IP</code>



______________

### **GET A SHELL** 

Nos conectamos por SSH con el usuario Joker y su password:

![](https://i.imgur.com/FBLgRmC.png)



____________________

### **USER FLAG**

En el directorio de joker vemos la user.txt flag.

<mark>Tenemos la user flag: **THM{d5781e53b130efe2f94f9b0354a5e4ea}**</mark>

_____________________

### **ROOT FLAG**

Vamos a intentar una escalada de privilegios en Linux siguiendo este [tutorial](https://jieliau.medium.com/privilege-escalation-on-linux-platform-8b3fbd0b1dd4). También podemos lanzar este [script](https://github.com/rebootuser/LinEnum) para enumerar el sistema.

1. En primer lugar, intentamos ver los privilegios de sudo del usuario joker. No puede ejecutar el comando <code>sudo -l</code>.

2. Buscamos los ficheros con el SUID activo. Podemos buscar alguno que nos llame la atención de esta [guía](https://gtfobins.github.io/)

    <code>find / -user root -perm -4000 2>/dev/null</code>

    ![](https://i.imgur.com/IGroLEv.png)

3. Nos llama la atención /bin/screen-4.5.0, aunque no hay explotación directa por SUID. Buscamos posibles exploits para esa versión de screen.

    - Encontramos este [exploit](https://www.exploit-db.com/exploits/41154) 

    - Lo descargamos y copiamos en la máquina. Al ejecutarlo nos encontramos con problemas. Probamos directamente a copiar todo el contenido en la terminal de la máquina:

        ![](https://i.imgur.com/wXpDWs7.png)

4. Hemos escalado privilegios. Vamos al directorio /root a por la 2a Flag.

    <mark>Tenemos la root flag: **THM{5ecd98aa66a6abb670184d7547c8124a}**</mark>
